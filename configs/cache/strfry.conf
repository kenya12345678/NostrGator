##
## Strfry Cache Relay Configuration
## High-performance caching and search relay for premium Nostr features
##

# Database configuration
db = "/app/strfry-db/"
dbParams {
    # LMDB settings for high performance
    maxreaders = 256
    mapsize = 10995116277760  # 10TB virtual (strfry default)
    noReadAhead = false
}

# Event handling
events {
    # Maximum size of normalised JSON, in bytes
    maxEventSize = 131072  # 128KB

    # Events newer than this will be rejected (15 minutes)
    rejectEventsNewerThanSeconds = 900

    # Events older than this will be rejected (3 years)
    rejectEventsOlderThanSeconds = 94608000

    # Ephemeral events older than this will be rejected
    rejectEphemeralEventsOlderThanSeconds = 60

    # Ephemeral events will be deleted from the DB when older than this
    ephemeralEventsLifetimeSeconds = 300

    # Maximum number of tags allowed
    maxNumTags = 2000

    # Maximum size for tag values, in bytes
    maxTagValSize = 1024
}

# Relay configuration
relay {
    bind = "0.0.0.0"
    port = 7777

    # Set OS-limit on maximum number of open files/sockets
    nofiles = 1000000

    # HTTP header that contains the client's real IP
    realIpHeader = ""

    info {
        # NIP-11: Name of this server
        name = "Private Cache Relay"

        # NIP-11: Detailed information about relay
        description = "High-performance private cache relay with search capabilities"

        # NIP-11: Administrative nostr pubkey
        pubkey = ""

        # NIP-11: Alternative administrative contact
        contact = ""

        # NIP-11: URL pointing to an image to be used as an icon
        icon = ""

        # List of supported NIPs (including search)
        nips = "[1,2,4,9,11,22,28,40,50,70,77]"
    }

    # Maximum accepted incoming websocket frame size
    maxWebsocketPayloadSize = 131072

    # Maximum number of filters allowed in a REQ
    maxReqFilterSize = 200

    # Websocket-level PING message frequency
    autoPingSeconds = 55

    # If TCP keep-alive should be enabled
    enableTcpKeepalive = false

    # How much uninterrupted CPU time a REQ query should get
    queryTimesliceBudgetMicroseconds = 10000

    # Maximum records that can be returned per filter
    maxFilterLimit = 5000  # Higher for cache relay

    # Maximum number of subscriptions per connection
    maxSubsPerConnection = 20

    writePolicy {
        # Allow all writes for cache relay
        plugin = ""
    }

    compression {
        # Use permessage-deflate compression
        enabled = true

        # Maintain a sliding window buffer for each connection
        slidingWindow = true
    }

    logging {
        # Dump all incoming messages
        dumpInAll = true

        # Dump all incoming EVENT messages
        dumpInEvents = true

        # Dump all incoming REQ/CLOSE messages
        dumpInReqs = true

        # Log performance metrics for initial REQ database scans
        dbScanPerf = true

        # Log reason for invalid event rejection
        invalidEvents = true
    }

    numThreads {
        # Ingester threads: route incoming requests, validate events/sigs
        ingester = 3

        # reqWorker threads: Handle initial DB scan for events
        reqWorker = 3

        # reqMonitor threads: Handle filtering of new events
        reqMonitor = 3

        # negentropy threads: Handle negentropy protocol messages
        negentropy = 2
    }

    negentropy {
        # Support negentropy protocol messages
        enabled = true

        # Maximum records that sync will process before returning an error
        maxSyncEvents = 1000000
    }
}


